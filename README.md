# Telegram Announcer Bot for AWS Lambda

This project implements a Telegram bot that listens to messages in a group chat. When a message from an authorized user contains the hashtag "#анонс", the bot reposts that message to a specified Telegram channel.

The bot is designed to be deployed as an AWS Lambda function via AWS SAM (Serverless Application Model) and uses GitHub Actions for CI/CD.

## Features

*   Reposts messages containing a specific keyword (`#анонс`) from authorized users.
*   Forwards messages to a designated Telegram channel.
*   Serverless deployment on AWS Lambda.
*   Automated build and deployment using GitHub Actions.
*   Secure handling of secrets and webhook verification.

## Architecture Overview

1.  A user posts a message in the source Telegram chat.
2.  If the bot is added to the chat, Telegram sends an update to a configured webhook.
3.  The webhook URL points to an **AWS API Gateway** endpoint.
4.  API Gateway triggers the **AWS Lambda function**.
5.  The Lambda function (Python code in `src/`) processes the update:
    *   Verifies the request using a `X-Telegram-Bot-Api-Secret-Token` header.
    *   Checks if the message contains `#анонс` (case-insensitive).
    *   Checks if the message sender is in the list of `AUTHORIZED_USER_IDS`.
    *   If both conditions are met, the bot forwards the original message to the `TARGET_CHANNEL_ID`.
6.  **GitHub Actions** are used for Continuous Integration and Continuous Deployment (CI/CD). Pushing to the `main` branch automatically builds the Docker image, pushes it to Amazon ECR, and deploys the application using AWS SAM.

## Prerequisites

*   **AWS Account:** To host the Lambda function, API Gateway, and ECR repository.
*   **Telegram Bot:** Create a bot using [BotFather](https://core.telegram.org/bots#botfather) on Telegram to get a `TELEGRAM_BOT_TOKEN`.
*   **AWS SAM CLI:** (Optional, for local development/deployment) [Install SAM CLI](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html).
*   **Docker:** (Optional, for local development/deployment as SAM uses it) [Install Docker](https://docs.docker.com/get-docker/).
*   **GitHub Account:** To host the repository and use GitHub Actions.

## Setup and Deployment

### 1. Clone the Repository

```bash
git clone <your-repository-url>
cd <repository-name>
```

### 2. Configure GitHub Secrets

Navigate to your GitHub repository's `Settings` > `Secrets and variables` > `Actions` and add the following secrets:

*   `AWS_IAM_ROLE_FOR_GITHUB_ACTIONS`: The ARN of the IAM Role that GitHub Actions will assume to deploy to AWS. See "IAM Role for GitHub Actions" below.
*   `AWS_REGION`: The AWS region where resources will be deployed (e.g., `us-east-1`).
*   `ECR_REPOSITORY_URI`: The URI of the Amazon ECR repository where the bot's Docker image will be stored. You need to create this ECR repository in your AWS account first (e.g., `123456789012.dkr.ecr.us-east-1.amazonaws.com/my-telegram-bot`).
*   `TELEGRAM_BOT_TOKEN`: Your Telegram bot token obtained from BotFather.
*   `AUTHORIZED_USER_IDS`: A comma-separated list of Telegram user IDs who are authorized to trigger announcements (e.g., `123456789,987654321`).
*   `TARGET_CHANNEL_ID`: The ID of the Telegram channel where announcements should be reposted (e.g., `-1001234567890` for a public/private channel, or `@channelusername` for public channels).
*   `TELEGRAM_WEBHOOK_SECRET_TOKEN`: A strong, random string (e.g., generated by a password manager) that will be used to verify that webhook requests are genuinely from Telegram. This same token must be used when setting the webhook with Telegram.

### 3. IAM Role for GitHub Actions (OIDC)

Create an IAM role in your AWS account that GitHub Actions can assume.
*   **Trusted entity type**: Select "Web identity".
*   **Identity provider**: Choose "GitHub".
*   **Audience**: `sts.amazonaws.com` (usually default).
*   **GitHub organization/repository**: Specify your GitHub organization and/or repository to restrict which workflows can assume this role.
*   **Permissions**: Attach policies that grant necessary permissions for SAM deployments. This typically includes permissions for CloudFormation (to manage stacks), ECR (to push images), Lambda (to create/update functions), API Gateway, and IAM (to pass roles). Apply the principle of least privilege.

Store the ARN of this role in the `AWS_IAM_ROLE_FOR_GITHUB_ACTIONS` GitHub secret.

### 4. Amazon ECR Repository

Create an ECR repository in your AWS account in the desired region. The name should match what you configure in the `ECR_REPOSITORY_URI` secret.

### 5. Deployment via GitHub Actions

Once the secrets, IAM role, and ECR repository are configured, committing and pushing changes to the `main` branch will automatically trigger the GitHub Actions workflow defined in `.github/workflows/deploy.yml`. This workflow will:
1.  Build the Docker image.
2.  Push the image to your ECR repository.
3.  Deploy the application stack (Lambda, API Gateway, etc.) using AWS SAM.

Check the "Actions" tab in your GitHub repository for deployment progress and logs. The SAM deployment output will include the `TelegramBotApiEndpoint`.

### 6. Set the Webhook with Telegram

After the first successful deployment, you need to tell Telegram where to send updates for your bot. Use the `TelegramBotApiEndpoint` from the SAM deployment output (found in GitHub Actions logs).

Construct the URL as follows:
`https_waf_url/bot<YOUR_TELEGRAM_BOT_TOKEN>/setWebhook?url=<YOUR_API_GATEWAY_ENDPOINT_URL_FROM_OUTPUT>&secret_token=<YOUR_TELEGRAM_WEBHOOK_SECRET_TOKEN>`

Replace placeholders:
*   `<YOUR_TELEGRAM_BOT_TOKEN>`: Your actual bot token.
*   `<YOUR_API_GATEWAY_ENDPOINT_URL_FROM_OUTPUT>`: The `TelegramBotApiEndpoint` value.
*   `<YOUR_TELEGRAM_WEBHOOK_SECRET_TOKEN>`: The same secret token you configured in GitHub Secrets.

Open this constructed URL in a web browser or use a tool like `curl`. Telegram should respond with `{"ok":true,"result":true,"description":"Webhook was set"}`.

Your bot is now live!

## Project Structure

```
.
├── .github/workflows/deploy.yml  # GitHub Actions CI/CD workflow
├── src/
│   ├── lambda_function.py        # AWS Lambda handler
│   ├── main.py                   # Core bot logic (message handling)
│   └── requirements.txt          # Python dependencies
├── Dockerfile                    # Defines the Docker image for Lambda
├── template.yaml                 # AWS SAM template for infrastructure
├── README.md                     # This file
└── .gitignore
```

## Local Development & Testing (Optional)

1.  **Install AWS SAM CLI and Docker.**
2.  **Configure AWS Credentials locally.**
3.  **Build:**
    ```bash
    sam build --use-container
    ```
4.  **Deploy (guided):**
    ```bash
    sam deploy --guided
    ```
    This will prompt you for parameters, including the ones you'd set as GitHub Secrets. It can also help create the ECR repository and CloudFormation stack initially.
5.  **Local Invocation (for `lambda_function.py`):**
    You can test the Lambda function locally using `sam local invoke`. You'll need to craft a sample event JSON that mimics an API Gateway event from Telegram. See `src/lambda_function.py` for an example mock event structure (commented out).

## Security Notes

*   **Secrets:** Never hardcode your `TELEGRAM_BOT_TOKEN`, `AUTHORIZED_USER_IDS`, `TARGET_CHANNEL_ID`, or `TELEGRAM_WEBHOOK_SECRET_TOKEN` in the code. Use environment variables, populated via GitHub Secrets and SAM parameters.
*   **Webhook Verification:** The bot uses a `TELEGRAM_WEBHOOK_SECRET_TOKEN` and checks the `X-Telegram-Bot-Api-Secret-Token` header to ensure requests are from Telegram.
*   **IAM Permissions:** Follow the principle of least privilege for the Lambda execution role (managed by SAM) and the GitHub Actions IAM role.

EOF

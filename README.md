# Telegram Announcer Bot for AWS Lambda (ZIP Deployment)

This project implements a Telegram bot that listens to messages in a group chat. When a message from an authorized user contains the hashtag "#анонс", the bot reposts that message to a specified Telegram channel.

The bot is designed to be deployed as an AWS Lambda function (packaged as a ZIP archive) via AWS SAM (Serverless Application Model) and uses GitHub Actions for CI/CD.

## Features

*   Reposts messages containing a specific keyword (`#анонс`) from authorized users.
*   Forwards messages to a designated Telegram channel.
*   Serverless deployment on AWS Lambda using ZIP packaging.
*   Automated build and deployment using GitHub Actions.
*   Secure handling of secrets and webhook verification.

## Architecture Overview

1.  A user posts a message in the source Telegram chat.
2.  If the bot is added to the chat, Telegram sends an update to a configured webhook.
3.  The webhook URL points to an **AWS API Gateway** endpoint.
4.  API Gateway triggers the **AWS Lambda function**.
5.  The Lambda function (Python code in `src/`, packaged as a ZIP) processes the update:
    *   Verifies the request using a `X-Telegram-Bot-Api-Secret-Token` header.
    *   Checks if the message contains `#анонс` (case-insensitive).
    *   Checks if the message sender is in the list of `AUTHORIZED_USER_IDS`.
    *   If both conditions are met, the bot forwards the original message to the `TARGET_CHANNEL_ID`.
6.  **GitHub Actions** are used for Continuous Integration and Continuous Deployment (CI/CD). Pushing to the `main` branch automatically builds the ZIP package and deploys the application using AWS SAM.

## Prerequisites

*   **AWS Account:** To host the Lambda function and API Gateway.
*   **Telegram Bot:** Create a bot using [BotFather](https://core.telegram.org/bots#botfather) on Telegram to get a `TELEGRAM_BOT_TOKEN`.
*   **AWS SAM CLI:** (Optional, for local development/manual deployment) [Install SAM CLI](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html).
*   **Docker:** (Optional, but recommended for local testing with SAM) [Install Docker](https://docs.docker.com/get-docker/). SAM uses Docker to simulate the Lambda environment for `sam local invoke` and `sam local start-api`.
*   **GitHub Account:** To host the repository and use GitHub Actions.

## Setup and Deployment

### 1. Clone the Repository

```bash
git clone <your-repository-url>
cd <repository-name>
```

### 2. Configure GitHub Repository Variables

Navigate to your GitHub repository's `Settings` > `Secrets and variables` > `Actions`. Under the "Variables" tab (or "Configuration variables"), add the following:

*   `AWS_REGION`: The AWS region where resources will be deployed (e.g., `us-east-1`).
*   `AUTHORIZED_USER_IDS`: A comma-separated list of Telegram user IDs who are authorized to trigger announcements (e.g., `123456789,987654321`).
*   `TARGET_CHANNEL_ID`: The ID of the Telegram channel where announcements should be reposted (e.g., `-1001234567890` for a public/private channel, or `@channelusername`).

### 3. Configure GitHub Secrets

Navigate to your GitHub repository's `Settings` > `Secrets and variables` > `Actions`. Under the "Secrets" tab, add the following:

*   `AWS_IAM_ROLE_FOR_GITHUB_ACTIONS`: The ARN of the IAM Role that GitHub Actions will assume to deploy to AWS. See "IAM Role for GitHub Actions" below.
*   `TELEGRAM_BOT_TOKEN`: Your Telegram bot token obtained from BotFather.
*   `TELEGRAM_WEBHOOK_SECRET_TOKEN`: A strong, random string (e.g., generated by a password manager) that will be used to verify that webhook requests are genuinely from Telegram. This same token must be used when setting the webhook with Telegram.

### 4. IAM Role for GitHub Actions (OIDC)

Create an IAM role in your AWS account that GitHub Actions can assume.
*   **Trusted entity type**: Select "Web identity".
*   **Identity provider**: Choose "GitHub" (or add it manually if not listed: Provider URL `https://token.actions.githubusercontent.com`, Audience `sts.amazonaws.com`).
*   **Audience**: `sts.amazonaws.com`.
*   **GitHub organization/repository/username**: Specify your GitHub details to restrict which workflows can assume this role.
*   **Permissions**: Attach policies that grant necessary permissions for SAM deployments (CloudFormation, Lambda, API Gateway, IAM pass role). Apply the principle of least privilege.

Store the ARN of this role in the `AWS_IAM_ROLE_FOR_GITHUB_ACTIONS` GitHub secret.

### 5. Deployment via GitHub Actions

Once the variables, secrets, and IAM role are configured, committing and pushing changes to the `main` branch will automatically trigger the GitHub Actions workflow defined in `.github/workflows/deploy.yml`. This workflow will:
1.  Build the Lambda deployment package (a ZIP file containing code and dependencies).
2.  Deploy the application stack (Lambda, API Gateway, etc.) using AWS SAM.

Check the "Actions" tab in your GitHub repository for deployment progress and logs. The SAM deployment output will include the `TelegramBotApiEndpoint`.

### 6. Set the Webhook with Telegram

After the first successful deployment, you need to tell Telegram where to send updates for your bot. Use the `TelegramBotApiEndpoint` from the SAM deployment output (found in GitHub Actions logs).

Construct the URL as follows:
`https_waf_url/bot<YOUR_TELEGRAM_BOT_TOKEN>/setWebhook?url=<YOUR_API_GATEWAY_ENDPOINT_URL_FROM_OUTPUT>&secret_token=<YOUR_TELEGRAM_WEBHOOK_SECRET_TOKEN>`

Replace placeholders:
*   `<YOUR_TELEGRAM_BOT_TOKEN>`: Your actual bot token (from GitHub Secrets).
*   `<YOUR_API_GATEWAY_ENDPOINT_URL_FROM_OUTPUT>`: The `TelegramBotApiEndpoint` value.
*   `<YOUR_TELEGRAM_WEBHOOK_SECRET_TOKEN>`: The same secret token you configured in GitHub Secrets.

Open this constructed URL in a web browser or use a tool like `curl`. Telegram should respond with `{"ok":true,"result":true,"description":"Webhook was set"}`.

Your bot is now live!

## Project Structure

```
.
├── .github/workflows/deploy.yml  # GitHub Actions CI/CD workflow
├── src/
│   ├── lambda_function.py        # AWS Lambda handler
│   ├── main.py                   # Core bot logic (message handling)
│   └── requirements.txt          # Python dependencies
├── template.yaml                 # AWS SAM template for infrastructure
├── README.md                     # This file
└── .gitignore
```

## Local Development & Testing (Optional)

1.  **Install AWS SAM CLI.**
2.  **Install Docker (Recommended for `sam local` commands).**
3.  **Configure AWS Credentials locally.**
4.  **Build (for ZIP package):**
    ```bash
    sam build
    ```
5.  **Deploy (guided, for ZIP package):**
    ```bash
    sam deploy --guided
    ```
    This will prompt you for parameters. For local testing, you can enter values directly.
6.  **Local Invocation (for `lambda_function.py`):**
    You can test the Lambda function locally using `sam local invoke`.

## Security Notes

*   **Secrets:** `TELEGRAM_BOT_TOKEN`, `TELEGRAM_WEBHOOK_SECRET_TOKEN`, and `AWS_IAM_ROLE_FOR_GITHUB_ACTIONS` must be kept as GitHub Secrets.
*   **Variables:** `AWS_REGION`, `AUTHORIZED_USER_IDS`, and `TARGET_CHANNEL_ID` are configured as GitHub Repository/Organization Variables.
*   **Webhook Verification:** The bot uses a `TELEGRAM_WEBHOOK_SECRET_TOKEN` for security.
*   **IAM Permissions:** Follow the principle of least privilege.

EOF
